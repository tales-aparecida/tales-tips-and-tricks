<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Tales L. Aparecida"><meta name=description content="How to combine IGT GPU Tools with Git bisect to report an issue in the AMDGPU driver"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Finding bugs using IGT and git bisect"><meta name=twitter:description content="How to combine IGT GPU Tools with Git bisect to report an issue in the AMDGPU driver"><meta property="og:title" content="Finding bugs using IGT and git bisect"><meta property="og:description" content="How to combine IGT GPU Tools with Git bisect to report an issue in the AMDGPU driver"><meta property="og:type" content="article"><meta property="og:url" content="https://tales-aparecida.github.io/tales-tips-and-tricks/posts/dri-devel/gsoc-report-2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-12T12:00:00-03:00"><meta property="article:modified_time" content="2022-06-12T12:00:00-03:00"><title>Tales Tips and Tricks</title><link rel=canonical href=https://tales-aparecida.github.io/tales-tips-and-tricks/posts/dri-devel/gsoc-report-2/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/tales-tips-and-tricks/css/coder.min.6b1a4fbc48955b72aea7913e43fabeb45e8bc120da5aa41b598dd33adcac4b59.css integrity="sha256-axpPvEiVW3Kup5E+Q/q+tF6LwSDaWqQbWY3TOtysS1k=" crossorigin=anonymous media=screen><link rel=stylesheet href=/tales-tips-and-tricks/css/coder-dark.min.39e41a7f16bdf8cb16e43cae7d714fa1016f1d2d2898a5b3f27f42c9979204e2.css integrity="sha256-OeQafxa9+MsW5DyufXFPoQFvHS0omKWz8n9CyZeSBOI=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/tales-tips-and-tricks/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/tales-tips-and-tricks/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/tales-tips-and-tricks/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/tales-tips-and-tricks/images/apple-touch-icon.png><link rel=manifest href=/tales-tips-and-tricks/site.webmanifest><link rel=mask-icon href=/tales-tips-and-tricks/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.100.2"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/tales-tips-and-tricks>Tales Tips and Tricks</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/tales-tips-and-tricks/posts/dri-devel>DRI-Devel</a></li><li class=navigation-item><a class=navigation-link href=/tales-tips-and-tricks/posts/>Other topics</a></li><li class=navigation-item><a class=navigation-link href=/tales-tips-and-tricks/categories/>Categories</a></li><li class=navigation-item><a class=navigation-link href=/tales-tips-and-tricks/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/tales-tips-and-tricks/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://tales-aparecida.github.io/tales-tips-and-tricks/posts/dri-devel/gsoc-report-2/>Finding bugs using IGT and git bisect</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-06-12T12:00:00-03:00>June 12, 2022</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read</span></div><div class=authors><i class="fa fa-user" aria-hidden=true></i>
<a href=/tales-tips-and-tricks/authors/tales-l.-aparecida/>Tales L. Aparecida</a></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/tales-tips-and-tricks/categories/dri-devel/>DRI-Devel</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tales-tips-and-tricks/tags/gsoc/>gsoc</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tales-tips-and-tricks/tags/kernel/>kernel</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tales-tips-and-tricks/tags/amdgpu/>amdgpu</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tales-tips-and-tricks/tags/igt/>igt</a></span></div></div></header><div><img src=/tales-tips-and-tricks/images/repair-bug.jpg alt="Featured image"><p>The first step to eliminate bugs is to find a way how to reproduce them consistently. <em>Wait&mldr; what?</em></p><p>Test suites are great for that, since they can simulate very specific behavior in a timely manner. <a href=https://gitlab.freedesktop.org/drm/igt-gpu-tools>IGT GPU Tools</a> is a collection of tools for development and testing of the DRM drivers, and, as such, it can help us to find and reproduce bugs.</p><p>I intend to help expand the AMDGPU tests&rsquo; list in my the <a href=https://summerofcode.withgoogle.com/proposals/details/TKAqZe03>GSoC project</a>, so it made sense trying to run them right away. Cloned and built the IGT project then tried to run the &ldquo;amdgpu&rdquo; tests using a TTY in <a href=https://ubuntuhandbook.org/index.php/2020/05/boot-ubuntu-20-04-command-console/>text mode</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ./scripts/run-tests.sh -t <span style=color:#e6db74>&#34;.*amdgpu.*&#34;</span>
</span></span></code></pre></div><p>Unfortunately, the tests failed and <em>never came to a stop</em>. I tried interrupting the process using different techniques but, in the end, had to reboot pressing the Reset button. Looking through the partial results I found that one of the subtests of <code>amd_cs_nop</code> was causing the problem&mldr; But why weren&rsquo;t the test just failing or crashing?</p><p>In an attempt to debug what was happening inside the subtest I enabled the DRM debugging messages with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>echo 0x19F | sudo tee /sys/module/drm/parameters/debug
</span></span></code></pre></div><p>This <a href=https://01.org/linuxgraphics/gfx-docs/drm/gpu/drm-internals.html#c.drm_debug_category>mask</a> activates all debugging logs but &ldquo;verbose vblank&rdquo; and &ldquo;verbose atomic state&rdquo;. Unfortunately, again, this debugging logs only managed to show me, with my limited knowledge, that <em>something</em> had been locked in an infinite loop.</p><div class="notice tip"><div class=notice-title><i class="fa fa-lightbulb-o" aria-hidden=true></i>Tip</div><div class=notice-content>Ask for help!</div></div><p>After sharing my experience with my mentors, they assured me the problem was <em>probably</em> caused by the kernel code itself, not with my setup or my compilation <code>.config</code>. So, to pinpoint what part of the code was causing the problem I could look through space (stepping throughout the calls with <strong>gdb</strong>) or time (using <strong>git</strong>) and I choose the latter.</p><p>So now the plan was to find when the bug was introduced. Luckily it wasn&rsquo;t so hard, a single <code>git checkout</code> to the previous release in the <a href=git@gitlab.freedesktop.org:agd5f/linux.git><code>amd-staging-drm-next</code></a> branch, which was <code>v5.16</code>, only 1000 commits or so behind the HEAD of the branch. It might seem like a lot to go through, but our time-machine is quite fast: <a href=https://git-scm.com/docs/git-bisect><code>git bisect</code></a>.</p><p>According to Wikipedia, the <a href=https://en.wikipedia.org/wiki/Bisection_method>bisection method</a> is a root-finding method that applies to any continuous function for which one knows two values with opposite signs. You probably already know it as binary-search. In this case, we are searching for the first commit in which the test fails, so to start our journey</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git bisect start
</span></span><span style=display:flex><span>git bisect bad <span style=color:#75715e># HEAD</span>
</span></span><span style=display:flex><span>git bisect good v5.16
</span></span></code></pre></div><p>And with it, <code>git</code> informs us there will be around 10 steps and checks out to the middle of those commits. For each step, build, deploy, reboot into the new kernel and run tests. Quite tedious and time consuming. Right now, I&rsquo;m not sure I could do it in a QEMU environment, but certainly, if I ever need to bisect the kernel in the future I&rsquo;ll look into it, because in that case I would be able to use <code>git bisect run</code>, which would allow the whole process to be automatized.</p><div class="notice tip"><div class=notice-title><i class="fa fa-lightbulb-o" aria-hidden=true></i>Tip</div><div class=notice-content>Always read the <strong>build</strong> result before <strong>deploying</strong>.</div></div><p>In the end, the whole process took a full afternoon&mldr; just to find myself in a failed bisection. I had the misfortune of making some mistake in the middle of the road, probably skipping the <em>build</em> step by accident due to a compiling error, and marked a commit with the wrong flag. After restarting the bisect in the following day, I made sure to avoid my mistake be renaming each build with the short hash of the commit I was compiling. And finally 🎉, found the first broken commit: <a href=https://gitlab.freedesktop.org/agd5f/linux/-/commit/e68efb27647f2106d6b545667f35b2ea39746b57>https://gitlab.freedesktop.org/agd5f/linux/-/commit/e68efb27647f2106d6b545667f35b2ea39746b57</a></p><p>Well&mldr; at least, I found the commit where the <code>amd_cs_nop</code> started failing. It looks promising, given it handles a mutex lock, and my mentors think so as well. Next step was reporting the bug, by simply creating an issue following the &ldquo;BUG template&rdquo; given at <a href=https://gitlab.freedesktop.org/drm/amd/-/issues/>https://gitlab.freedesktop.org/drm/amd/-/issues/</a>:</p><div class="notice info"><div class=notice-title><i class="fa fa-exclamation-circle" aria-hidden=true></i>Info</div><div class=notice-content><a href=https://gitlab.freedesktop.org/drm/amd/-/issues/2048>https://gitlab.freedesktop.org/drm/amd/-/issues/2048</a></div></div><p>And that&rsquo;s that. Thanks for reading. ❤️</p><hr><p>&ldquo;Repair Bug&rdquo; by AZRainman is licensed under CC BY 2.0.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2021 -
2022
Tales L. Aparecida
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/tales-tips-and-tricks/js/coder.min.f411a1043e37c7c14dfb03f4d94d60d9ee69cfa413b16d0fd4f28695babb82bb.js integrity="sha256-9BGhBD43x8FN+wP02U1g2e5pz6QTsW0P1PKGlbq7grs="></script></body></html>