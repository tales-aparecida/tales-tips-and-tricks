<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>igt on Tales Tips and Tricks</title><link>https://tales-aparecida.github.io/tales-tips-and-tricks/tags/igt/</link><description>Recent content in igt on Tales Tips and Tricks</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Sun, 12 Jun 2022 12:00:00 -0300</lastBuildDate><atom:link href="https://tales-aparecida.github.io/tales-tips-and-tricks/tags/igt/index.xml" rel="self" type="application/rss+xml"/><item><title>Finding bugs using IGT and git bisect</title><link>https://tales-aparecida.github.io/tales-tips-and-tricks/posts/dri-devel/gsoc-report-2/</link><pubDate>Sun, 12 Jun 2022 12:00:00 -0300</pubDate><guid>https://tales-aparecida.github.io/tales-tips-and-tricks/posts/dri-devel/gsoc-report-2/</guid><description>&lt;p>The first step to eliminate bugs is to find a way how to reproduce them consistently. &lt;em>Wait&amp;hellip; what?&lt;/em>&lt;/p>
&lt;p>Test suites are great for that, since they can simulate very specific behavior in a timely manner. &lt;a href="https://gitlab.freedesktop.org/drm/igt-gpu-tools">IGT GPU Tools&lt;/a> is a collection of tools for development and testing of the DRM drivers, and, as such, it can help us to find and reproduce bugs.&lt;/p>
&lt;p>I intend to help expand the AMDGPU tests&amp;rsquo; list in my the &lt;a href="https://summerofcode.withgoogle.com/proposals/details/TKAqZe03">GSoC project&lt;/a>, so it made sense trying to run them right away. Cloned and built the IGT project then tried to run the &amp;ldquo;amdgpu&amp;rdquo; tests using a TTY in &lt;a href="https://ubuntuhandbook.org/index.php/2020/05/boot-ubuntu-20-04-command-console/">text mode&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ ./scripts/run-tests.sh -t &lt;span style="color:#e6db74">&amp;#34;.*amdgpu.*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Unfortunately, the tests failed and &lt;em>never came to a stop&lt;/em>. I tried interrupting the process using different techniques but, in the end, had to reboot pressing the Reset button. Looking through the partial results I found that one of the subtests of &lt;code>amd_cs_nop&lt;/code> was causing the problem&amp;hellip; But why weren&amp;rsquo;t the test just failing or crashing?&lt;/p>
&lt;p>In an attempt to debug what was happening inside the subtest I enabled the DRM debugging messages with:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>echo 0x19F | sudo tee /sys/module/drm/parameters/debug
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This &lt;a href="https://01.org/linuxgraphics/gfx-docs/drm/gpu/drm-internals.html#c.drm_debug_category">mask&lt;/a> activates all debugging logs but &amp;ldquo;verbose vblank&amp;rdquo; and &amp;ldquo;verbose atomic state&amp;rdquo;. Unfortunately, again, this debugging logs only managed to show me, with my limited knowledge, that &lt;em>something&lt;/em> had been locked in an infinite loop.&lt;/p>
&lt;div class="notice tip">
&lt;div class="notice-title">
&lt;i class="fa fa-lightbulb-o" aria-hidden="true">&lt;/i>Tip
&lt;/div>
&lt;div class="notice-content">Ask for help!&lt;/div>
&lt;/div>
&lt;p>After sharing my experience with my mentors, they assured me the problem was &lt;em>probably&lt;/em> caused by the kernel code itself, not with my setup or my compilation &lt;code>.config&lt;/code>. So, to pinpoint what part of the code was causing the problem I could look through space (stepping throughout the calls with &lt;strong>gdb&lt;/strong>) or time (using &lt;strong>git&lt;/strong>) and I choose the latter.&lt;/p>
&lt;p>So now the plan was to find when the bug was introduced. Luckily it wasn&amp;rsquo;t so hard, a single &lt;code>git checkout&lt;/code> to the previous release in the &lt;a href="git@gitlab.freedesktop.org:agd5f/linux.git">&lt;code>amd-staging-drm-next&lt;/code>&lt;/a> branch, which was &lt;code>v5.16&lt;/code>, only 1000 commits or so behind the HEAD of the branch. It might seem like a lot to go through, but our time-machine is quite fast: &lt;a href="https://git-scm.com/docs/git-bisect">&lt;code>git bisect&lt;/code>&lt;/a>.&lt;/p>
&lt;p>According to Wikipedia, the &lt;a href="https://en.wikipedia.org/wiki/Bisection_method">bisection method&lt;/a> is a root-finding method that applies to any continuous function for which one knows two values with opposite signs. You probably already know it as binary-search. In this case, we are searching for the first commit in which the test fails, so to start our journey&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>git bisect start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>git bisect bad &lt;span style="color:#75715e"># HEAD&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>git bisect good v5.16
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>And with it, &lt;code>git&lt;/code> informs us there will be around 10 steps and checks out to the middle of those commits. For each step, build, deploy, reboot into the new kernel and run tests. Quite tedious and time consuming. Right now, I&amp;rsquo;m not sure I could do it in a QEMU environment, but certainly, if I ever need to bisect the kernel in the future I&amp;rsquo;ll look into it, because in that case I would be able to use &lt;code>git bisect run&lt;/code>, which would allow the whole process to be automatized.&lt;/p>
&lt;div class="notice tip">
&lt;div class="notice-title">
&lt;i class="fa fa-lightbulb-o" aria-hidden="true">&lt;/i>Tip
&lt;/div>
&lt;div class="notice-content">Always read the &lt;strong>build&lt;/strong> result before &lt;strong>deploying&lt;/strong>.&lt;/div>
&lt;/div>
&lt;p>In the end, the whole process took a full afternoon&amp;hellip; just to find myself in a failed bisection. I had the misfortune of making some mistake in the middle of the road, probably skipping the &lt;em>build&lt;/em> step by accident due to a compiling error, and marked a commit with the wrong flag. After restarting the bisect in the following day, I made sure to avoid my mistake be renaming each build with the short hash of the commit I was compiling. And finally 🎉, found the first broken commit: &lt;a href="https://gitlab.freedesktop.org/agd5f/linux/-/commit/e68efb27647f2106d6b545667f35b2ea39746b57">https://gitlab.freedesktop.org/agd5f/linux/-/commit/e68efb27647f2106d6b545667f35b2ea39746b57&lt;/a>&lt;/p>
&lt;p>Well&amp;hellip; at least, I found the commit where the &lt;code>amd_cs_nop&lt;/code> started failing. It looks promising, given it handles a mutex lock, and my mentors think so as well. Next step was reporting the bug, by simply creating an issue following the &amp;ldquo;BUG template&amp;rdquo; given at &lt;a href="https://gitlab.freedesktop.org/drm/amd/-/issues/">https://gitlab.freedesktop.org/drm/amd/-/issues/&lt;/a>:&lt;/p>
&lt;div class="notice info">
&lt;div class="notice-title">
&lt;i class="fa fa-exclamation-circle" aria-hidden="true">&lt;/i>Info
&lt;/div>
&lt;div class="notice-content">&lt;a href="https://gitlab.freedesktop.org/drm/amd/-/issues/2048">https://gitlab.freedesktop.org/drm/amd/-/issues/2048&lt;/a>&lt;/div>
&lt;/div>
&lt;p>And that&amp;rsquo;s that. Thanks for reading. ❤️&lt;/p>
&lt;hr>
&lt;p>&amp;ldquo;Repair Bug&amp;rdquo; by AZRainman is licensed under CC BY 2.0. To view a copy of this license, visit &lt;a href="https://creativecommons.org/licenses/by/2.0/?ref=openverse">https://creativecommons.org/licenses/by/2.0/?ref=openverse&lt;/a>.&lt;/p></description></item></channel></rss>